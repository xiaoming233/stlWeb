<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
	<style type="text/css">
		body, html,#allmap {width: 100%;height: 100%;overflow: hidden;margin:0;font-family:"微软雅黑";}
/*          #login_register{float: left;height:90%;} */
		#d1{float: right;height:100%;width:80%;}		
		#map1{height:100%;width:100%;}
/* 		#map2{float: right;height:100%;width:50%; } */
		#r-result{position:absolute;left:700px;top:0;}
	</style>
	<link href="css/searchBox.css" rel="stylesheet" type="text/css" />
	<link href="css/bootstrap.css" rel="stylesheet" /> 
	<link href="css/login-register.css" rel="stylesheet" /> 
	<link href="css/operation.css" rel="stylesheet" /> 
	<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=E06eb9d756d0eafc722effb355657b4c"></script>
	<script type="text/javascript" src="/stlWeb/js/LuShu_min.js"></script>
	<script type="text/javascript" src="/stlWeb/js/searchBox.js"></script>
	<script src="js/jquery-1.10.2.js"></script>
	<script src="js/bootstrap.js" type="text/javascript"></script>
	<script src="js/login-register.js" type="text/javascript"></script> 
	<title>快快配送路径分析系统</title>
</head>
<body onload="sendRequest()">
<div class="operation">
    <div class="head">
	<span>快快配送</span>
	</div>
      <div style="height:20%;width:100%; "></div>
		<div class="row">
            <div class="col-sm-4"></div>
            <div class="col-sm-4">
                 <a class="btn big-login" data-toggle="modal" href="javascript:void(0)" onclick="openLoginModal();">登 录</a>
                 <div style="height:10px;width:100%; "></div>
                 <a class="btn big-register" data-toggle="modal" href="javascript:void(0)" onclick="openRegisterModal();">注 册</a></div>
            <div class="col-sm-4"></div>
        </div>
        <div class="history" id="history" style="display:none"></div>	
</div>
<div id="login_register">
<div class="modal fade login" id="loginModal">
		      <div class="modal-dialog login animated">
    		      <div class="modal-content">
    		         <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title">登录</h4>
                    </div>
                    <div class="modal-body">  
                        <div class="box">
                             <div class="content">
                                <div class="error"></div>
                                <div class="form loginBox">
                                    <form method="post" action="/login" accept-charset="UTF-8">
                                    <input id="email" class="form-control" type="text" placeholder="邮箱" name="email">
                                    <input id="password" class="form-control" type="password" placeholder="密码" name="password">
                                    <input class="btn btn-default btn-login" type="button" value="登 录" onclick="loginAjax()">
                                    </form>
                                </div>
                             </div>
                        </div>
                        <div class="box">
                            <div class="content registerBox" style="display:none;">
                             <div class="form">
                                <form method="post" html="{:multipart=>true}" data-remote="true" action="/register" accept-charset="UTF-8">
                                <input id="nickname" class="form-control" type="text" placeholder="昵称" name="nickname">
                                <input id="email" class="form-control" type="text" placeholder="邮箱" name="email">
                                <input id="password" class="form-control" type="password" placeholder="密码" name="password">
                                <input id="password_confirmation" class="form-control" type="password" placeholder="确认密码" name="password_confirmation">
                                <input class="btn btn-default btn-register" type="submit" value="注 册" name="commit">
                                </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <div class="forgot login-footer">
                            <span>没有账户？
                                 <a href="javascript: showRegisterForm();">立即注册</a>
                            </span>
                        </div>
                        <div class="forgot register-footer" style="display:none">
                             <span>已有账户?</span>
                             <a href="javascript: showLoginForm();">立即登录</a>
                        </div>
                    </div>        
    		      </div>
		      </div>
		  </div> 
		 
</div>
   <div id="d1">
	<div id="map1"></div>
	</div>
		 
	<div id="result" ></div>

<!-- <button id="next">next</button>   -->
 <p name="remarks" id="remarks" ></p>
</body>
</html>
<script type="text/javascript">
var pointsNameAnt=new Array();
var pointsNameGreedy=new Array();
var pointsLocationAnt=new Array();
var pointsLocationGreedy=new Array();
 
//字符串转json对象
function strToJson(str) {
	return JSON.parse(str);
}

	// 百度地图API功能
	var zoom = 14;
	var map = new BMap.Map("map1");
	map.centerAndZoom(new BMap.Point(113.358409, 23.145426), 16);
	 map.enableScrollWheelZoom(true);  
	 map.addControl(new BMap.NavigationControl());
/* 	 map2.centerAndZoom(new BMap.Point(113.358409, 23.145426), 16);
	 map2.enableScrollWheelZoom(true);   */
	 function ZoomControl(){
		  // 默认停靠位置和偏移量
		  this.defaultAnchor = BMAP_ANCHOR_TOP_LEFT;
		  this.defaultOffset = new BMap.Size(300, 55);
		}
	    ZoomControl.prototype = new BMap.Control();

		// 自定义控件必须实现自己的initialize方法,并且将控件的DOM元素返回
		// 在本方法中创建个div元素作为控件的容器,并将其添加到地图容器中
		ZoomControl.prototype.initialize = function(map){
		  // 创建一个DOM元素
		  var div = document.createElement("div");
		  // 设置样式
		  div.style.cursor = "pointer";
		  div.style.border = "1px solid gray";
		  div.style.backgroundColor = "white";

	      var b1 = document.createElement("input");
	            b1.type = "button";
	            b1.value = "next";
	            b1.onclick = function () {
	            	 showPath(); 
	            }
	         div.appendChild(b1);
	         var b2 = document.createElement("input");
	            b2.type = "button";
	            b2.value = "run";
	            b2.onclick = function () {
	            	lushu1.start();
	        	    lushu2.start();
	        	    lushu1.hideInfoWindow();
	        	    lushu2.showInfoWindow();
	            }
	         div.appendChild(b2);
	         var b3 = document.createElement("input");
	            b3.type = "button";
	            b3.value = "pause";
	            b3.onclick = function () {
	            	 lushu1.pause();
	         	    lushu2.pause();
	            }
	         div.appendChild(b3);
		  // 添加DOM元素到地图中
		  map.getContainer().appendChild(div);
		  // 将DOM元素返回
		  return div;
		}
		// 创建控件
		var myZoomCtrl = new ZoomControl();
		// 添加到地图当中
		map.addControl(myZoomCtrl);
		
		var searchbox = new SearchBox({anchor:BMAP_ANCHOR_TOP_LEFT});// 创建搜索控件对象，并设置它停靠在地图的左上位置
        searchbox.city = "广州市";// 在北京市查找数据
        searchbox.callback = function(point){// 设置回调函数
            // 如果找到地址了就在该坐标添加一个标记
            if(point)
            {
                map.centerAndZoom(point, zoom);
                var marker = new BMap.Marker(point);
                map.addOverlay(marker);
            	marker.addContextMenu(markerMenu);
               	markerMenu.addItem(new BMap.MenuItem('删除',removeMarker.bind(marker)));
            }
            else
            {
                alert("没查到数据！");
            }
        }
        map.addControl(searchbox);  // 将搜索控件添加到地图上
        var removeMarker = function(e,ee,marker){
    		map.removeOverlay(marker); 
            }
       	var markerMenu=new BMap.ContextMenu();

/*         var arrSelectPoint=[];
        map.addEventListener("rightclick",function(e){
        	arrSelectPoint.push( new BMap.Point(e.point.lng , e.point.lat));
    	}); */
/*         var removeMarker = function(e,ee,marker){
    		map.removeOverlay(marker); */
    	
        /* var menu = new BMap.ContextMenu();
    	var txtMenuItem = [
    		{
    			text:'添加',
    			callback:function(e){
    				var marker = new BMap.Marker(arrSelectPoint[0]);
    				map.addOverlay(marker);}
    		},
    		{
    			text:'删除',
    			callback:removeMarker.bind(marker)
    		}
    	];
    	for(var i=0; i < txtMenuItem.length; i++){
    		menu.addItem(new BMap.MenuItem(txtMenuItem[i].text,txtMenuItem[i].callback,100));
    	}
    	map.addContextMenu(menu); */
	var lushu1;
	var lushu2;
	var myIcon = new BMap.Icon("http://api.map.baidu.com/lbsapi/cloud/cms/Mario.png",
	            {width:128,height:128},{anchor:new BMap.Size(65,128)});    
	// 实例化一个步行导航用来生成路线
	var arrPoisAnt=[];
	var arrPoisGreedy=[];
	var max;
	var strDistance;
	function setPoint()
	{
		var s;
		for(var m=0;m<max;m++)
			{
			s=m+1;
			var mark1 = new BMap.Marker(pointsLocationAnt[m]);
			map.addOverlay(mark1);
			var mark2 = new BMap.Marker(pointsLocationGreedy[m]);
			map.addOverlay(mark2);
			var lab1 = new BMap.Label(s+pointsNameAnt[m], { position:pointsLocationAnt[m] });
			var lab2 = new BMap.Label(s+pointsNameGreedy[m], { position:pointsLocationGreedy[m] });
			map.addOverlay(lab1);	
			map.addOverlay(lab2);
			}
		var str1="蚁群算法："+pointsNameAnt[0]+"->"+pointsNameAnt[1];
		var wkr1 = new BMap.WalkingRoute('广州');
		   wkr1.search(pointsLocationAnt[0], pointsLocationAnt[1]);
		   wkr1.setSearchCompleteCallback(function(res) {
		        if (wkr1.getStatus() == BMAP_STATUS_SUCCESS) {
		        	var arrPath=res.getPlan(0).getRoute(0).getPath()			        		        					        	
		        	map.addOverlay(new BMap.Polyline(arrPath, {strokeColor: 'red'}));
			           map.setViewport(arrPath);
			           for (var i = 0; i < arrPath.length; i++) {
			        	   arrPoisAnt.push(new BMap.Point(arrPath[i].lng, arrPath[i].lat));
			   		}
		        }
		  });
		   var str2="贪心法："+pointsNameGreedy[0]+"->"+pointsNameGreedy[1];
		   var wkr2 = new BMap.WalkingRoute('广州');
		   wkr2.search(pointsLocationGreedy[0], pointsLocationGreedy[1]);
		   wkr2.setSearchCompleteCallback(function(res) {
		        if (wkr2.getStatus() == BMAP_STATUS_SUCCESS) {
		        	var arrPath=res.getPlan(0).getRoute(0).getPath()			        		        					        	
		        	map2.addOverlay(new BMap.Polyline(arrPath, {strokeColor: 'green'}));
			           map2.setViewport(arrPath);
			           for (var i = 0; i < arrPath.length; i++) {
			        	   arrPoisGreedy.push(new BMap.Point(arrPath[i].lng, arrPath[i].lat));
			   		}
		        }
		  }); 
	}
	var m=1;
	function showPath()
	{
		if(m<max )
		{
			var str1="蚁群算法："+pointsNameAnt[m]+"->"+pointsNameAnt[m+1];
	  var wkr1 = new BMap.WalkingRoute('广州');
	   wkr1.search(pointsLocationAnt[m], pointsLocationAnt[m+1]);
	   wkr1.setSearchCompleteCallback(function(res) {
	        if (wkr1.getStatus() == BMAP_STATUS_SUCCESS) {
	        	var arrPath=res.getPlan(0).getRoute(0).getPath()			        		        					        	
	        	map.addOverlay(new BMap.Polyline(arrPath, {strokeColor: 'red'}));
		           map.setViewport(arrPath);
		           for (var i = 0; i < arrPath.length; i++) {
		        	   arrPoisAnt.push(new BMap.Point(arrPath[i].lng, arrPath[i].lat));
		   		}
	        }
	  }); 
	   var str2="贪心法："+pointsNameGreedy[m]+"->"+pointsNameGreedy[m+1];
	   var wkr2 = new BMap.WalkingRoute('广州');
	   wkr2.search(pointsLocationGreedy[m], pointsLocationGreedy[m+1]);
	   wkr2.setSearchCompleteCallback(function(res) {
	        if (wkr2.getStatus() == BMAP_STATUS_SUCCESS) {
	        	var arrPath=res.getPlan(0).getRoute(0).getPath()			        		        					        	
	        	map2.addOverlay(new BMap.Polyline(arrPath, {strokeColor: 'green'}));
		           map2.setViewport(arrPath);
		           for (var i = 0; i < arrPath.length; i++) {
		        	   arrPoisGreedy.push(new BMap.Point(arrPath[i].lng, arrPath[i].lat));
		   		}
	        }
	  }); 
	   m++
	  }
		else
			{
			 document.getElementById("remarks").innerHTML = strDistance;
			 lushu1 = new BMapLib.LuShu(map,arrPoisAnt,{
	               defaultContent:'',
	               speed:150,
	               icon:myIcon,
	              });
			 lushu2 = new BMapLib.LuShu(map2,arrPoisGreedy,{
	               defaultContent:'',
	               speed:150,
	               icon:myIcon,
	              });
			 
			}
   }

	/* //绑定事件
	$("run").onclick = function(){
	    lushu1.start();
	    lushu2.start();
	    lushu1.hideInfoWindow();
	    lushu2.showInfoWindow();
	}
	$("stop").onclick = function(){
	    lushu1.stop();
	    lushu2.stop();
	}
	$("pause").onclick = function(){
	    lushu1.pause();
	    lushu2.pause();
	}
	/* $("next").onclick = function(){
		 showPath();
	} */	
	/* function $(element){
	    return document.getElementById(element);
	} */ 
	
	var XMLHttpReq; 
	//创建XMLHttpRequest对象         
	function createXMLHttpRequest() {  
	    if(window.XMLHttpRequest) { //Mozilla 浏览器  
	        XMLHttpReq = new XMLHttpRequest();  
	    }  
	   else if (window.ActiveXObject) { // IE浏览器  
	            XMLHttpReq = new ActiveXObject("Microsoft.XMLHTTP");  
	        }   
	}  
	//发送请求函数  
	function sendRequest() {  
	    createXMLHttpRequest();  
	    var url = "tsp";  
	    XMLHttpReq.open("GET", url, true);  
	    XMLHttpReq.onreadystatechange = processResponse;//指定响应函数  
	    XMLHttpReq.send(null);  // 发送请求  
	}  
	// 处理返回信息函数  
	function processResponse() {  
	    if (XMLHttpReq.readyState == 4) { // 判断对象状态  
	        if (XMLHttpReq.status == 200 ) { // 信息已经成功返回，开始处理信息  
	       	 var strJson =strToJson(XMLHttpReq.responseText);
	       	 //var dataObj=eval('('+strJson+')');
	       	  var antValue = strToJson(strJson.Ant);
	       	  var greedyValue =  strToJson(strJson.Greedy);
	       	strDistance='蚁群算法总距离为:'+strJson.dstAnt+',贪心法总距离为:'+strJson.dstGreedy;
	       	for(var j = 0 ; j <antValue.length-1 ; j++ ){
	       		var p=new BMap.Point(antValue[j].lng,antValue[j].lat);
	       		pointsLocationAnt[j]=p;
	       		pointsNameAnt[j]=antValue[j].name;
	       	}
	       	pointsLocationAnt.push(pointsLocationAnt[0]);
	       	pointsNameAnt.push(pointsNameAnt[0]);
	       	for(var j = 0 ; j <greedyValue.length-1 ; j++ ){
	       		var p=new BMap.Point(greedyValue[j].lng,greedyValue[j].lat);
	       		pointsLocationGreedy[j]=p;
	       		pointsNameGreedy[j]=greedyValue[j].name;
	       	}
	       	pointsLocationGreedy.push(pointsLocationGreedy[0]);
	       	pointsNameGreedy.push(pointsNameGreedy[0]);
	       	 //var valueObj=eval('('+values+')');
	       	 //alert(valueObj[0]);
	       	// points=eval("(" + pointlist[0] + ")");
	       	 //alert(points.length);
	       	 max=pointsLocationAnt.length-1;
	       	setPoint();
	       	//setTimeout(showPath, 4000);
	       	 //var str=pointsNameAnt[0]+"->"+pointsNameAnt[1];
	       	 //initwkr( str);
	       	//wkr.search(pointsLocationAnt[0], pointsLocationAnt[1]);
	        } else { //页面不正常  
	            window.alert(XMLHttpReq.status);  
	        }  
	    } 
	    
	}
	
</script>